<!DOCTYPE html>
<html>
<head>
  <title>Radar Live</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { margin:0; font-family: system-ui, sans-serif; }
    #map { height: 100vh; width: 100%; }

    .panel {
      position: absolute;
      top: 15px;
      left: 15px;
      background: white;
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      z-index: 1000;
      min-width:200px;
    }

    .connected { color: green; font-weight:bold }

    #disconnectBtn {
      margin-top:8px;
      width:100%;
      padding:8px;
      border:none;
      border-radius:8px;
      background:#ef4444;
      color:white;
      font-weight:bold;
      cursor:pointer;
      display:none;
    }

    #chat {
      position:absolute;
      bottom:20px;
      right:20px;
      width:300px;
      background:white;
      border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
      display:none;
      overflow:hidden;
      z-index:1000;
    }

    #chatHeader {
      background:#2563eb;
      color:white;
      padding:10px;
      font-weight:bold;
    }

    #messages {
      height:250px;
      overflow-y:auto;
      padding:10px;
    }

    #chat input {
      flex:1;
      padding:10px;
      border:none;
    }

    #chat button {
      background:#2563eb;
      color:white;
      border:none;
      padding:10px;
      cursor:pointer;
    }

    /* ONBOARDING */
    #onboard {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }

    #onboardBox {
      background:white;
      width:320px;
      border-radius:12px;
      padding:20px;
      box-shadow:0 20px 50px rgba(0,0,0,.4);
      text-align:center;
    }

    #onboardBox h2 { margin:0 0 10px }
    #onboardBox p { color:#555; font-size:14px }

    #onboardBox input {
      width:100%;
      padding:10px;
      margin:8px 0;
      border:1px solid #ddd;
      border-radius:8px;
      font-size:14px;
    }

    #startBtn {
      width:100%;
      margin-top:10px;
      padding:12px;
      border:none;
      border-radius:8px;
      background:#2563eb;
      color:white;
      font-weight:bold;
      cursor:pointer;
    }

    #error {
      color:red;
      font-size:13px;
      margin-top:8px;
      display:none;
    }
  </style>
</head>

<body>

<!-- ONBOARDING -->
<div id="onboard">
  <div id="onboardBox">
    <h2>Radar</h2>
    <p>Find people nearby who share your interest â€” right now.</p>

    <input id="nameInput" placeholder="Your name">
    <input id="interestInput" placeholder="Interest (e.g. chess, cricket)">

    <button id="startBtn">Start</button>
    <div id="error"></div>
  </div>
</div>

<div class="panel">
  <b id="me"></b><br>
  <span id="status">ðŸŸ¡ Searching nearby players...</span>
  <button id="disconnectBtn" onclick="disconnect()">Disconnect</button>
</div>

<div id="map"></div>

<div id="chat">
  <div id="chatHeader">Chat</div>
  <div id="messages"></div>
  <div style="display:flex;border-top:1px solid #ddd">
    <input id="msg" placeholder="Type...">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const API = "https://radarbackend-production-d61c.up.railway.app";

let user_id = null;
let interest = null;

let myLat = null;
let myLng = null;
let connectedWith = null;
let chatInitializedFor = null;
let isLocked = false; // ðŸ”¥ MATCH LOCK

let ws = null;

/* LOAD IDENTITY */
function loadIdentity() {
  const u = localStorage.getItem("radar_user");
  const i = localStorage.getItem("radar_interest");

  if (u && i) {
    user_id = u;
    interest = i;
    startApp();
  } else {
    onboard.style.display = "flex";
  }
}

/* START BUTTON */
startBtn.onclick = () => {
  let n = nameInput.value.trim();
  let it = interestInput.value.trim().toLowerCase();

  if (!n || !it) return showError("Name and interest required.");
  if (n.length > 20 || it.length > 20) return showError("Max 20 characters.");

  localStorage.setItem("radar_user", n);
  localStorage.setItem("radar_interest", it);

  user_id = n;
  interest = it;
  startApp();
};

function showError(t){
  error.innerText = t;
  error.style.display = "block";
}

/* START CORE */
function startApp() {
  onboard.style.display = "none";
  me.innerText = `${user_id} â€” ${interest}`;

  initMap();
  initWS();
  initGPS();
  initHeartbeat();
}

/* MAP */
let map = null;
let myMarker = null;
let markers = {};

function initMap(){
  map = L.map("map").setView([0,0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* WS */
function initWS(){
  ws = new WebSocket(`wss://radarbackend-production-d61c.up.railway.app/ws/${user_id}`);

  ws.onmessage = e => {
    let data = JSON.parse(e.data);

    if (data.type === "connected") {
      if (data.a !== user_id && data.b !== user_id) return;

      if (isLocked) return; // ðŸ”¥ HARD LOCK

      let other = data.a === user_id ? data.b : data.a;

      isLocked = true;
      connectedWith = other;
      chatInitializedFor = other;

      status.innerHTML = "ðŸŸ¢ Connected with <b>" + connectedWith + "</b>";
      disconnectBtn.style.display = "block";

      chat.style.display = "block";
      chatHeader.innerText = "Chat with " + connectedWith;

      messages.innerHTML = "";
      loadChat();
      return;
    }

    if (data.type === "message") {
      addMessage(data.data.from, data.data.text);
      return;
    }

    if (data.type === "update") {
      if (isLocked) return; // ðŸ”¥ freeze map after match

      let id = data.user;
      if (!myLat) return;

      if (markers[id]) map.removeLayer(markers[id]);

      let dist = distance(myLat, myLng, data.lat, data.lng);

      let popup = `
        <b>${id}</b><br>
        ${data.interest}<br>
        ${Math.round(dist)} m away<br>
        Searching
      `;

      markers[id] = L.marker([data.lat, data.lng]).addTo(map).bindPopup(popup);
    }
  };
}

/* GPS */
function initGPS(){
  navigator.geolocation.watchPosition(pos => {
    myLat = pos.coords.latitude;
    myLng = pos.coords.longitude;

    if (!myMarker) {
      map.setView([myLat, myLng], 16);
      myMarker = L.marker([myLat, myLng]).addTo(map).bindPopup("You").openPopup();
    } else {
      myMarker.setLatLng([myLat, myLng]);
    }
  }, () => alert("Location permission is required"));
}

/* HEARTBEAT */
function initHeartbeat(){
  setInterval(() => {
    if (!myLat) return;

    if (isLocked) return; // ðŸ”¥ STOP MATCHING

    fetch(`${API}/heartbeat?user_id=${user_id}&lat=${myLat}&lng=${myLng}&interest=${interest}`, {
      method:"POST"
    }).catch(()=>{});
  }, 8000);
}

/* DISCONNECT */
function disconnect(){
  connectedWith = null;
  chatInitializedFor = null;
  isLocked = false;

  status.innerHTML = "ðŸŸ¡ Searching nearby players...";
  disconnectBtn.style.display = "none";

  chat.style.display = "none";
  messages.innerHTML = "";

  // Clear markers
  Object.values(markers).forEach(m => map.removeLayer(m));
  markers = {};
}

/* CHAT */
function sendMsg(){
  let t = msg.value;
  if(!t || !connectedWith) return;

  fetch(`${API}/send_message?from_user=${user_id}&to_user=${connectedWith}&text=${encodeURIComponent(t)}`, {
    method:"POST"
  });

  msg.value="";
}

function addMessage(f,t){
  let d=document.createElement("div");
  d.innerHTML="<b>"+f+":</b> "+t;
  messages.appendChild(d);
  messages.scrollTop=999999;
}

function loadChat(){
  fetch(`${API}/chat_history?user=${user_id}&other=${connectedWith}`)
    .then(r=>r.json())
    .then(m=>{
      messages.innerHTML="";
      m.forEach(x=>{
        let j=JSON.parse(x.replace(/'/g,'"'));
        addMessage(j.from,j.text);
      });
    });
}

function distance(a,b,c,d){
  let R=6371000;
  let dLat=(c-a)*Math.PI/180;
  let dLon=(d-b)*Math.PI/180;
  let q=Math.sin(dLat/2)**2 +
        Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180) *
        Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q)));
}

/* INIT */
loadIdentity();

</script>
</body>
</html>




