<!DOCTYPE html>
<html>
<head>
<title>Communify</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body{margin:0;font-family:system-ui,sans-serif;background:#f8fafc;}

.leaflet-marker-icon,.leaflet-div-icon{
background:none!important;border:none!important;box-shadow:none!important;width:0!important;height:0!important;
}

.emoji-marker{
position:absolute;transform:translate(-50%,-50%);
font-size:28px;line-height:28px;pointer-events:auto;
filter:drop-shadow(0 0 4px rgba(37,99,235,0.6));
}

/* JOIN SCREEN */

#join{
position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
background:linear-gradient(135deg,#7c3aed,#ec4899,#f59e0b);
z-index:2000;color:white;overflow:hidden;
}

#join:before,#join:after{
content:"";position:absolute;width:420px;height:420px;border-radius:50%;
filter:blur(90px);opacity:.35;
}
#join:before{background:#fde68a;top:-120px;left:-120px;}
#join:after{background:#c4b5fd;bottom:-120px;right:-120px;}

#joinBox{
position:relative;background:white;color:black;padding:36px;border-radius:20px;width:360px;
box-shadow:0 30px 70px rgba(0,0,0,.28);text-align:center;
animation:pop .35s ease;
}

@keyframes pop{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}

.badge{
display:inline-block;background:#f3e8ff;color:#7c3aed;
font-size:12px;padding:4px 10px;border-radius:20px;margin-bottom:12px;font-weight:600;
}

#joinBox h1{
margin:6px 0;font-size:30px;
background:linear-gradient(135deg,#7c3aed,#ec4899);
-webkit-background-clip:text;-webkit-text-fill-color:transparent;
}

.tagline{color:#555;font-size:15px;margin-bottom:18px;line-height:1.4;}
.micro{font-size:12px;color:#888;margin-top:8px;}

#joinBox input,#joinBox select{
width:100%;padding:13px;margin-bottom:14px;border-radius:12px;
border:1px solid #ddd;font-size:15px;
}

#joinBox button{
width:100%;padding:14px;
background:linear-gradient(135deg,#7c3aed,#ec4899);
color:white;border:none;border-radius:14px;font-size:16px;
cursor:pointer;font-weight:600;
box-shadow:0 8px 24px rgba(0,0,0,.25);
}

/* MAP */

#map{height:100vh;width:100%;}

.panel{
position:absolute;top:80px;left:15px;background:white;padding:12px 15px;
border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.15);z-index:1000;
}

/* CHAT */

#chat{
position:absolute;bottom:20px;right:20px;width:330px;background:white;border-radius:14px;
box-shadow:0 20px 50px rgba(0,0,0,.35);display:none;overflow:hidden;z-index:1000;
border:1px solid #e5e7eb;
}

#chatHeader{
background:#2563eb;color:white;padding:12px;font-weight:bold;
display:flex;justify-content:space-between;align-items:center;
}

#messages{height:260px;overflow-y:auto;padding:12px;background:#f1f5f9;}

#typing{padding:6px 12px;background:#f1f5f9;display:none;}

.typingBubble{display:inline-flex;gap:4px;padding:6px 10px;background:#e5e7eb;border-radius:12px;width:42px;justify-content:center;}

.typingDot{
width:6px;height:6px;background:#6b7280;border-radius:50%;
animation:blink 1.4s infinite both;
}
.typingDot:nth-child(2){animation-delay:.2s}
.typingDot:nth-child(3){animation-delay:.4s}

@keyframes blink{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-3px)}}

.msgRow{display:flex;margin:6px 0;}
.msgMine{justify-content:flex-end;}
.msgOther{justify-content:flex-start;}

.bubble{
padding:8px 12px;border-radius:14px;max-width:70%;
font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.mine{background:#2563eb;color:white;}
.other{background:#e5e7eb;color:black;}

.time{font-size:10px;opacity:.7;margin-top:2px;text-align:right;}

#inputBar{display:flex;border-top:1px solid #ddd;background:white;}
#msg{flex:1;padding:10px;border:none;font-size:14px;}

#chat button{background:#2563eb;color:white;border:none;padding:10px 12px;cursor:pointer;}

.emojiBar{display:flex;gap:6px;padding:6px;border-top:1px solid #eee;background:white;}
.emojiBar button{background:#f1f5f9;border:none;border-radius:6px;padding:4px 6px;cursor:pointer;}

#disconnectBtn{background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;}

/* MODAL */

#modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.3);z-index:3000;}
#modalBox{background:white;padding:20px;border-radius:12px;width:300px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2);}
#modalBox button{margin:10px;padding:8px 14px;border:none;border-radius:8px;cursor:pointer;}

/* TOAST */

#toast{
position:fixed;
bottom:30px;
left:50%;
transform:translateX(-50%) translateY(20px);
background:#111827;
color:white;
padding:12px 18px;
border-radius:12px;
box-shadow:0 10px 30px rgba(0,0,0,.35);
opacity:0;
pointer-events:none;
transition:.35s ease;
z-index:5000;
font-size:14px;
}
#toast.show{
opacity:1;
transform:translateX(-50%) translateY(0);
}
</style>
</head>

<body>

<div id="join">
<div id="joinBox">
<div class="badge">LIVE ‚Ä¢ people nearby now</div>

<h1>Comm(u)nify</h1>

<div class="tagline">
Turn proximity into community.<br>
Meet people around you with shared interests ‚Äî instantly.
</div>

<input id="nameInput" placeholder="Enter your name">

<select id="interestInput">
<option value="">Choose your interest</option>
<option value="chess">‚ôüÔ∏è Chess</option>
<option value="cricket">üèè Cricket</option>
<option value="music">üéµ Music</option>
<option value="startup">üöÄ Startup</option>
<option value="fitness">üí™ Fitness</option>
<option value="coding">üíª Coding</option>
</select>

<button onclick="start()">Start discovering</button>
<div class="micro">Location is used only to show nearby people.</div>
</div>
</div>

<div id="toast"></div>

<div class="panel">
<b id="me"></b><br>
<span id="status">üü° Nearby users</span>
</div>

<div id="map"></div>

<div id="chat">
<div id="chatHeader">
<span id="chatTitle">Chat</span>
<button id="disconnectBtn" onclick="disconnect()">Disconnect</button>
</div>

<div id="messages"></div>

<div id="typing">
<div class="typingBubble">
<div class="typingDot"></div>
<div class="typingDot"></div>
<div class="typingDot"></div>
</div>
</div>

<div class="emojiBar">
<button onclick="addEmoji('üòÄ')">üòÄ</button>
<button onclick="addEmoji('üî•')">üî•</button>
<button onclick="addEmoji('üëç')">üëç</button>
<button onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
</div>

<div id="inputBar">
<input id="msg" placeholder="Type message...">
<button onclick="sendMsg()">Send</button>
</div>
</div>

<div id="modal">
<div id="modalBox">
<div id="modalText"></div>
<button onclick="accept()">Accept</button>
<button onclick="reject()">Reject</button>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API="https://radarbackend-production-e6f8.up.railway.app";

/* TOAST */
const toastBox=document.getElementById("toast");
function toast(msg){
toastBox.innerText=msg;
toastBox.classList.add("show");
setTimeout(()=>toastBox.classList.remove("show"),2500);
}

/* SOUND */
const msgSound=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
let soundUnlocked=false;
document.addEventListener("click",()=>{
if(soundUnlocked)return;
msgSound.volume=0;
msgSound.play().then(()=>{
msgSound.pause();msgSound.currentTime=0;msgSound.volume=1;soundUnlocked=true;
});
},{once:true});

/* ICONS */
const ICONS={
cricket:L.divIcon({html:"<div class='emoji-marker'>üèè</div>",iconSize:[0,0]}),
chess:L.divIcon({html:"<div class='emoji-marker'>‚ôüÔ∏è</div>",iconSize:[0,0]}),
music:L.divIcon({html:"<div class='emoji-marker'>üéµ</div>",iconSize:[0,0]}),
startup:L.divIcon({html:"<div class='emoji-marker'>üöÄ</div>",iconSize:[0,0]}),
fitness:L.divIcon({html:"<div class='emoji-marker'>üí™</div>",iconSize:[0,0]}),
coding:L.divIcon({html:"<div class='emoji-marker'>üíª</div>",iconSize:[0,0]}),
default:L.divIcon({html:"<div class='emoji-marker'>üìç</div>",iconSize:[0,0]})
};

let user_id=null,interest=null,myLat=null,myLng=null,connectedWith=null,incomingFrom=null,ws=null,typingTimer=null;

let map=L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let myMarker=null,markers={};

function start(){
const name=nameInput.value.trim();
const int=interestInput.value;
if(!name||!int){toast("Enter name and interest");return;}
user_id=name+"-"+Math.floor(Math.random()*1000);
interest=int;
join.style.display="none";
me.innerText=`${name} ‚Äî ${interest}`;
initWS();
}

function initWS(){
ws=new WebSocket(`wss://radarbackend-production-e6f8.up.railway.app/ws/${user_id}`);

ws.onmessage=e=>{
let data=JSON.parse(e.data);

if(data.type==="match_request"){
incomingFrom=data.from;
modalText.innerText=`${incomingFrom} wants to connect`;
modal.style.display="flex";
return;
}

if(data.type==="connected"){
let other=data.a===user_id?data.b:data.a;
connectedWith=other;
chat.style.display="block";
chatTitle.innerText=`Chat with ${other.split("-")[0]} ‚Ä¢ ${interest}`;
messages.innerHTML="";
toast("Connected!");
loadChat();
return;
}

if(data.type==="partner_left"){
    if(data.user===connectedWith){
        toast("Partner left");
        chat.style.display="none";
        messages.innerHTML="";
        connectedWith=null;
    }
    return;
}  
  

if(data.type==="typing"){
if(data.from===connectedWith){
typing.style.display="block";
clearTimeout(typingTimer);
typingTimer=setTimeout(()=>typing.style.display="none",1500);
}
return;
}

if(data.type==="disconnected"){
if(data.with===connectedWith){
toast("Partner disconnected");
chat.style.display="none";
messages.innerHTML="";
connectedWith=null;
}
return;
}

if(data.type==="remove"){
let id=data.user;
if(markers[id]){
map.removeLayer(markers[id]);
delete markers[id];
}
return;
}  
if(data.type==="message"){
addMessage(data.data.from,data.data.text);
return;
}

if(data.type==="update"){
let id=data.user;
if(!myLat||id===user_id)return;
if(markers[id])map.removeLayer(markers[id]);
const icon=ICONS[data.interest]||ICONS.default;

let marker=L.marker([data.lat,data.lng],{icon}).addTo(map);
marker.bindPopup(`<b>${id.split("-")[0]}</b><br>${data.interest}<br><button id="connect_${id}">Connect</button>`);
marker.on("popupopen",()=>{
const btn=document.getElementById(`connect_${id}`);
if(btn) btn.onclick=()=>requestMatch(id);
});
markers[id]=marker;
}
};
}
  

navigator.geolocation.watchPosition(pos=>{
myLat=pos.coords.latitude;
myLng=pos.coords.longitude;
if(!myMarker){
map.setView([myLat,myLng],16);
myMarker=L.marker([myLat,myLng],{icon:ICONS.default}).addTo(map).bindPopup("You");
}else myMarker.setLatLng([myLat,myLng]);
});

setInterval(()=>{
if(!user_id||!myLat)return;
fetch(`${API}/heartbeat?user_id=${user_id}&lat=${myLat}&lng=${myLng}&interest=${interest}`,{method:"POST"});
},8000);

function requestMatch(other){
fetch(`${API}/request_match?from_user=${user_id}&to_user=${other}`,{method:"POST"});
}

function accept(){
if(!incomingFrom)return;
fetch(`${API}/accept_match?user_id=${user_id}&from_user=${incomingFrom}`,{method:"POST"});
modal.style.display="none";
incomingFrom=null;
}

function reject(){
modal.style.display="none";
incomingFrom=null;
}

function disconnect(){
fetch(`${API}/disconnect?user_id=${user_id}`,{method:"POST"});
chat.style.display="none";
messages.innerHTML="";
connectedWith=null;
toast("Disconnected");
}

function sendMsg(){
let t=msg.value.trim();
if(!t||!connectedWith)return;
fetch(`${API}/send_message?from_user=${user_id}&to_user=${connectedWith}&text=${encodeURIComponent(t)}`,{method:"POST"});
msg.value="";
}

function addEmoji(e){msg.value+=e;msg.focus();}
msg.addEventListener("keypress",e=>{if(e.key==="Enter")sendMsg();});

msg.addEventListener("input",()=>{
if(!connectedWith)return;
fetch(`${API}/typing?from_user=${user_id}&to_user=${connectedWith}`,{method:"POST"});
});

function addMessage(from,text){
if(from!==user_id && soundUnlocked){
msgSound.currentTime=0;
msgSound.play().catch(()=>{});
}
let row=document.createElement("div");
row.className="msgRow "+(from===user_id?"msgMine":"msgOther");
let bubble=document.createElement("div");
bubble.className="bubble "+(from===user_id?"mine":"other");
let time=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
bubble.innerHTML=`<div>${text}</div><div class="time">${time}</div>`;
row.appendChild(bubble);
messages.appendChild(row);
messages.scrollTop=messages.scrollHeight;
}

function loadChat(){
fetch(`${API}/chat_history?user=${user_id}&other=${connectedWith}`)
.then(r=>r.json())
.then(m=>{
messages.innerHTML="";
m.forEach(x=>{
let j=JSON.parse(x.replace(/'/g,'"'));
addMessage(j.from,j.text);
});
});
}
</script>

</body>
</html>







