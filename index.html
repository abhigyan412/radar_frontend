<!DOCTYPE html>
<html>
<head>
  <title>Radar Live</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { margin:0; font-family: system-ui, sans-serif; background:#f8fafc; }

    #join {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#f8fafc;
      z-index:2000;
    }

    #joinBox {
      background:white;
      padding:30px;
      border-radius:12px;
      width:320px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }

    #joinBox h2 {
      margin:0 0 15px 0;
    }

    #joinBox input,
    #joinBox select {
      width:100%;
      padding:10px;
      margin-bottom:12px;
      border-radius:8px;
      border:1px solid #ddd;
      font-size:14px;
    }

    #joinBox button {
      width:100%;
      padding:10px;
      background:#2563eb;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-size:15px;
    }

    #map { height: 100vh; width: 100%; }

    .panel {
      position: absolute;
      top: 15px;
      left: 15px;
      background: white;
      padding: 12px 15px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      z-index: 1000;
    }

    .connected { color: green; font-weight:bold }

    #chat {
      position:absolute;
      bottom:20px;
      right:20px;
      width:300px;
      background:white;
      border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.3);
      display:none;
      overflow:hidden;
      z-index:1000;
    }

    #chatHeader {
      background:#2563eb;
      color:white;
      padding:10px;
      font-weight:bold;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    #messages {
      height:250px;
      overflow-y:auto;
      padding:10px;
    }

    #chat input {
      flex:1;
      padding:10px;
      border:none;
    }

    #chat button {
      background:#2563eb;
      color:white;
      border:none;
      padding:10px;
      cursor:pointer;
    }

    #disconnectBtn {
      background:#ef4444;
      color:white;
      border:none;
      padding:4px 8px;
      border-radius:6px;
      cursor:pointer;
      font-size:12px;
    }
  </style>
</head>

<body>

<!-- JOIN SCREEN -->
<div id="join">
  <div id="joinBox">
    <h2>Join Radar</h2>
    <input id="nameInput" placeholder="Your name">
    <select id="interestInput">
      <option value="">Select interest</option>
      <option value="chess">Chess</option>
      <option value="cricket">Cricket</option>
      <option value="music">Music</option>
      <option value="startup">Startup</option>
      <option value="fitness">Fitness</option>
      <option value="coding">Coding</option>
    </select>
    <button onclick="start()">Start</button>
  </div>
</div>

<div class="panel">
  <b id="me"></b><br>
  <span id="status">ðŸŸ¡ Searching nearby players...</span>
</div>

<div id="map"></div>

<div id="chat">
  <div id="chatHeader">
    <span id="chatTitle">Chat</span>
    <button id="disconnectBtn" onclick="disconnect()">Disconnect</button>
  </div>
  <div id="messages"></div>
  <div style="display:flex;border-top:1px solid #ddd">
    <input id="msg" placeholder="Type...">
    <button onclick="sendMsg()">Send</button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

const API = "https://radarbackend-production-d61c.up.railway.app";

let user_id = null;
let interest = null;

let myLat = null;
let myLng = null;
let connectedWith = null;
let chatInitializedFor = null;
let inCooldown = false;
let lastDisconnectedFrom = null;
let ws = null;

/* START */
function start(){
  const name = nameInput.value.trim();
  const int = interestInput.value;

  if (!name || !int) {
    alert("Enter name and select interest");
    return;
  }

  user_id = name;
  interest = int;

  document.getElementById("join").style.display = "none";
  document.getElementById("me").innerText = `${user_id} â€” ${interest}`;

  initWS();
}

/* MAP */
let map = L.map("map").setView([0,0], 2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let myMarker = null;
let markers = {};

/* WEBSOCKET */
function initWS(){
  ws = new WebSocket(`wss://radarbackend-production-d61c.up.railway.app/ws/${user_id}`);

  ws.onmessage = e => {
    let data = JSON.parse(e.data);

    if (data.type === "disconnected") {
      if (data.with !== connectedWith) return;

      lastDisconnectedFrom = data.with;
      resetChatUI();
      inCooldown = true;

      document.getElementById("status").innerHTML =
        "â³ Disconnected. Searching for new players...";

      setTimeout(() => {
        inCooldown = false;
        lastDisconnectedFrom = null;
      }, 15000);

      return;
    }

    if (data.type === "connected") {
      if (data.a !== user_id && data.b !== user_id) return;

      let other = data.a === user_id ? data.b : data.a;

      if (inCooldown) return;
      if (other === lastDisconnectedFrom) return;
      if (chatInitializedFor === other) return;

      chatInitializedFor = other;
      connectedWith = other;

      document.getElementById("status").innerHTML =
        "ðŸŸ¢ Connected with <b>" + connectedWith + "</b>";

      document.getElementById("chat").style.display = "block";
      document.getElementById("chatTitle").innerText =
        "Chat with " + connectedWith;

      messages.innerHTML = "";
      loadChat();
      return;
    }

    if (data.type === "message") {
      addMessage(data.data.from, data.data.text);
      return;
    }

    if (data.type === "update") {
      let id = data.user;
      if (!myLat) return;

      if (markers[id]) map.removeLayer(markers[id]);

      let dist = distance(myLat, myLng, data.lat, data.lng);

      let popup = `
        <b>${id}</b><br>
        ${data.interest}<br>
        ${Math.round(dist)} m away<br>
        ${connectedWith === id ? "<span class='connected'>Connected</span>" : "Searching"}
      `;

      markers[id] = L.marker([data.lat, data.lng])
        .addTo(map)
        .bindPopup(popup);
    }
  };
}

/* GPS */
navigator.geolocation.watchPosition(pos => {
  myLat = pos.coords.latitude;
  myLng = pos.coords.longitude;

  if (!myMarker) {
    map.setView([myLat, myLng], 16);
    myMarker = L.marker([myLat, myLng])
      .addTo(map)
      .bindPopup("You")
      .openPopup();
  } else {
    myMarker.setLatLng([myLat, myLng]);
  }
});

/* HEARTBEAT */
setInterval(() => {
  if (!user_id) return;
  if (!myLat) return;
  if (inCooldown) return;

  fetch(`${API}/heartbeat?user_id=${user_id}&lat=${myLat}&lng=${myLng}&interest=${interest}`, {
    method:"POST"
  }).catch(()=>{});
}, 8000);

/* CHAT */
function sendMsg(){
  let t = msg.value;
  if(!t || !connectedWith) return;

  fetch(`${API}/send_message?from_user=${user_id}&to_user=${connectedWith}&text=${encodeURIComponent(t)}`, {
    method:"POST"
  });

  msg.value="";
}

function addMessage(f,t){
  let d=document.createElement("div");
  d.innerHTML="<b>"+f+":</b> "+t;
  messages.appendChild(d);
  messages.scrollTop=999999;
}

function loadChat(){
  if (!connectedWith) return;

  fetch(`${API}/chat_history?user=${user_id}&other=${connectedWith}`)
    .then(r=>r.json())
    .then(m=>{
      messages.innerHTML="";
      m.forEach(x=>{
        let j=JSON.parse(x.replace(/'/g,'"'));
        addMessage(j.from,j.text);
      });
    });
}

/* DISCONNECT */
function disconnect(){
  if (!connectedWith) return;

  lastDisconnectedFrom = connectedWith;

  fetch(`${API}/disconnect?user_id=${user_id}`, {
    method:"POST"
  });

  resetChatUI();
  inCooldown = true;

  document.getElementById("status").innerHTML =
    "â³ Disconnected. Searching for new players...";

  setTimeout(() => {
    inCooldown = false;
    lastDisconnectedFrom = null;
  }, 15000);
}

function resetChatUI(){
  connectedWith = null;
  chatInitializedFor = null;
  document.getElementById("chat").style.display = "none";
  messages.innerHTML = "";
}

/* DISTANCE */
function distance(a,b,c,d){
  let R=6371000;
  let dLat=(c-a)*Math.PI/180;
  let dLon=(d-b)*Math.PI/180;
  let q=Math.sin(dLat/2)**2 +
        Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180) *
        Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(q),Math.sqrt(1-q)));
}

</script>
</body>
</html>







